wandonye/backend:
  PreBuild:
    # Add any build pre-requisites here
    - echo "---PreBuild---"
    - nvm install 4.7.0
    - sudo curl https://install.meteor.com | /bin/sh
  Build:
    # Enter your build steps here!
    - echo "Begin Build"
    - docker login -u "$DISTELLI_DOCKER_USERNAME" -p "$DISTELLI_DOCKER_PW" -e "$DISTELLI_DOCKER_EMAIL" $DISTELLI_DOCKER_ENDPOINT
    - npm install --save babel-runtime moment toastr
    - npm install --production
    - meteor add rocketchat:internal-hubot meteorhacks:kadira
    - meteor build --server https://chat.linknitive.com --directory ./distelli
    - echo "--Creating Docker Image--"
    - docker build --quiet=false -t "$DISTELLI_DOCKER_REPO" "$DISTELLI_DOCKER_PATH"
    - docker tag "$DISTELLI_DOCKER_REPO" "$DISTELLI_DOCKER_REPO:$DISTELLI_BUILDNUM"
    - echo "--Pushing Docker Image--"
    - docker push "$DISTELLI_DOCKER_REPO:latest"

  PkgInclude:
    - '*'

  Env:
    # Set any environment variables in this section.
    # These are available during all phases of a deploy.
    - PORT: "3000"
    - FINDPORT_LOOP_CNT: "60"
    - FINDPORT_SLEEP: "2"
    - MONGO_URL : "mongodb://localhost:27017/rocketchat"
    - ROOT_URL : "https://chat.linknitive.com"

  PreInstall:
    # Use this section to install any deployment pre-requisites.
    - echo "---PreInstall---"
    - sudo docker login -u "$DISTELLI_DOCKER_USERNAME" -p $DISTELLI_DOCKER_PW -e "$DISTELLI_DOCKER_EMAIL" $DISTELLI_DOCKER_ENDPOINT

  PostInstall:
    - echo "---PostInstall---"
    - sudo rm -rf /etc/nginx/sites-enabled/default
    - sudo rm -rf /etc/nginx/sites-available/meteor
    - sudo mv meteor /etc/nginx/sites-available/meteor
    - sudo ln -sf /etc/nginx/sites-available/meteor /etc/nginx/sites-enabled/meteor

  Exec:
    - cd $DISTELLI_INSTALLHOME
    - echo "Up docker-compose for $DISTELLI_DOCKER_REPO:$DISTELLI_BUILDNUM and other images"
    - sudo /usr/local/bin/docker-compose up

  PostStart:
    - echo "---PostStart---"
    - time_amount=$(($FINDPORT_LOOP_CNT * $FINDPORT_SLEEP))
    - echo "--Checking over $time_amount seconds for up service on PORT $PORT--"
    - failure=1
    - for i in `seq 1 $FINDPORT_LOOP_CNT`; do
    -   echo "checking..."
    -   response=$(netstat -an | grep "LISTEN" | grep ":$PORT") || true
    -   echo "RESPONSE= $response"
    -   if [ "$response" != "" ]; then
    -     echo "Got $response."
    -     failure=0
    -     break
    -   fi
    -   sleep $FINDPORT_SLEEP
    - done
